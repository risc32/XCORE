# XCore Operating System - Техническая документация

## Обзор системы

XCore - это минималистичная операционная система для архитектуры x86/x86_64, написанная на C++ и ассемблере. Система предназначена для образовательных целей и встраиваемых систем, обеспечивая базовую функциональность ядра с современными возможностями.

### Ключевые характеристики
- **Архитектура**: x86/x86_64 с поддержкой защищенного режима
- **Язык**: C++ (стандарт C++14) с ассемблерными вставками
- **Размер ядра**: ~80MB heap space
- **Файловая система**: XCFS (XCore File System) v2.1
- **Графика**: VESA/VGA с поддержкой framebuffer
- **Память**: Собственный менеджер памяти с выравниванием

## Архитектура системы

### Двухэтапная загрузка
XCore использует двухэтапную систему загрузки:

1. **Stage 1** (`boot.asm`): Базовый загрузчик BIOS
2. **Stage 2** (`middle()` в kernel.cpp): Промежуточный загрузчик на 0x15000
3. **Kernel** (`_start()` в kernel.cpp): Основное ядро на 0x20000

### Карта памяти
```
0x7C00    - Boot sector (512 bytes)
0x15000   - Stage 2 loader
0x20000   - Kernel entry point
0xB8000   - VGA text buffer
0xA0000000 - Graphics framebuffer (VESA)
```

## Компоненты системы

### 1. Консольная подсистема (Console)

**Файл**: `os/kernel/console.cpp`

**Возможности**:
- Текстовый режим VGA 80x25
- Поддержка цветов (16 цветов переднего плана, 8 фона)
- Кодировка CP866 для кириллицы
- Обработка клавиатуры с поддержкой модификаторов
- Прокрутка экрана
- Курсор и редактирование строк

**Основные методы**:
```cpp
void write(const char* str)        // Вывод строки
void writeLine(const char* str)    // Вывод с переводом строки
void writeHex(int val)             // Вывод в шестнадцатеричном формате
string readLine()                  // Чтение строки с клавиатуры
void clear()                       // Очистка экрана
void set_color(VGAColor fg, VGAColor bg) // Установка цветов
```

**Поддерживаемые клавиши**:
- Алфавитно-цифровые символы
- Модификаторы: Shift, Ctrl, Alt, Caps Lock
- Стрелки навигации
- Backspace, Enter, Tab

### 2. Менеджер памяти (Memory Manager)

**Файл**: `os/kernel/memory/memory.cpp`

**Характеристики**:
- Размер кучи: 80MB
- Выравнивание: 32 байта
- Минимальный блок: 32 байта
- Максимальный блок: 512 байт

**Структура блока памяти**:
```cpp
struct memory_block {
    int mbid;              // Уникальный ID блока
    bool used;             // Флаг использования
    memory_block *next;    // Следующий блок
    memory_block *back;    // Предыдущий блок
    size_t size;          // Размер блока
};
```

**API функции**:
```cpp
void* allocate(size_t size)        // Выделение памяти
void free(void* ptr)               // Освобождение памяти
void* realloc(void* ptr, size_t size) // Перераспределение
void memcpy(void* dst, void* src, size_t n) // Копирование
void memset(void* ptr, int val, size_t n)   // Заполнение
```

### 3. Процессорная подсистема (CPU)

**Файл**: `os/kernel/CPU/cpu.cpp`

**Компоненты**:
- Обработка исключений процессора
- Управление портами ввода-вывода
- Трассировка стека
- RTTI (Run-Time Type Information)
- Регистры процессора

**Поддерживаемые исключения**:
- Division by zero
- Page fault
- General protection fault
- Stack overflow
- Invalid opcode

**Функции портов**:
```cpp
void outb(uint16_t port, uint8_t data)  // Вывод байта
uint8_t inb(uint16_t port)              // Ввод байта
void outw(uint16_t port, uint16_t data) // Вывод слова
uint16_t inw(uint16_t port)             // Ввод слова
```

### 4. Дисковая подсистема (Disk I/O)

**Файл**: `os/kernel/disk/disk.cpp`

**Драйвер**: ATA/IDE контроллер

**Возможности**:
- Чтение/запись секторов по LBA
- Поддержка до 2TB дисков
- Буферизованный ввод-вывод
- Автоматическое определение геометрии диска

**API**:
```cpp
void read(uint64_t lba, uint32_t count, char* buffer)  // Чтение секторов
bool write(uint64_t lba, const char* data)            // Запись сектора
managed<char> read(uint64_t lba, uint32_t count)      // Чтение с управляемой памятью
```

### 5. Файловая система XCFS

**Файл**: `os/kernel/xcfs/xcfs.cpp`

**Особенности**:
- Собственная файловая система XCore
- Версия 2.1
- Поддержка каталогов и файлов
- Битовая карта свободных блоков
- Индексные узлы (inodes)

**Структура суперблока**:
```cpp
struct super_block {
    char magic[4];        // "XCFS"
    uint32_t version;     // Версия ФС
    uint64_t kerneladdr;  // Адрес ядра
    uint32_t root;        // Корневой каталог
    // ... другие поля
};
```

**Операции**:
```cpp
void mount()                    // Монтирование ФС
void format()                   // Форматирование диска
inode create_file(string name)  // Создание файла
```

### 6. Графическая подсистема (Graphics)

**Файл**: `os/kernel/graphics/graphics.cpp`

**Поддерживаемые режимы**:
- VGA текстовый режим (80x25)
- VESA графический режим
- Framebuffer с 32-битным цветом

**Возможности**:
```cpp
void draw(uint32_t x, uint32_t y, uint32_t color)     // Рисование пикселя
void draw_rect(uint32_t x, y, w, h, uint32_t color)   // Прямоугольник
void clear(uint32_t color)                            // Очистка экрана
void frame()                                          // Обновление кадра
```

### 7. Система команд (Command System)

**Файл**: `os/kernel/cmd/cmd.cpp`

**Встроенные команды**:
- `help` - Справка по командам
- `clear` - Очистка экрана
- `reboot` - Перезагрузка системы
- `memory` - Информация о памяти
- `disk` - Операции с диском
- `serial0` - Операции с serial0

### 8. Автотестирование (Autotest)

**Файл**: `os/kernel/autotest/autotest.cpp`

**Тесты**:
- Тестирование памяти (allocate/free)
- Тестирование строк
- Тестирование файловых операций
- Проверка целостности системы

### 9. Управляемые объекты (Managed Objects)

**Файл**: `os/kernel/managed/managed.cpp`

**Возможности**:
- Автоматическое управление памятью
- Управляемые строки с автоматической очисткой
- Списки инициализации

### 10. Потоки ввода-вывода (Streams)

**Файл**: `os/kernel/stream/stream.cpp`

**Классы**:
```cpp
class KernelOut  // Поток вывода с поддержкой цветов
class KernelIn   // Поток ввода с буферизацией
```

**Операторы**:
```cpp
kout << "Hello" << endl;           // Вывод строки
kout << RED << "Error" << reset;   // Цветной вывод
string input = kin.readLine();     // Чтение строки
```

## Системные требования

### Аппаратные требования
- Процессор: x86_64
- ОЗУ: минимум 16MB, рекомендуется 64MB+
- Диск: ATA/IDE контроллер
- Видео: VGA совместимая карта или VESA

### Программные требования для сборки
- Компилятор: x86_64-elf-gcc
- Ассемблер: FASM (Flat Assembler)
- Эмулятор: QEMU

## Сборка и запуск

```batch
# Сборка
comp.bat

# Запуск в QEMU
run.bat
```


## Особенности реализации

### Многоэтапная инициализация
1. **BIOS/UEFI** - Определение типа прошивки
2. **FPU/SSE** - Инициализация математического сопроцессора
3. **Исключения** - Настройка обработчиков
4. **Консоль** - Инициализация текстового режима
5. **Диск** - Инициализация ATA драйвера
6. **Память** - Настройка менеджера памяти
7. **Автотесты** - Проверка компонентов
8. **Файловая система** - Монтирование XCFS
9. **Графика** - Инициализация VESA
10. **Командная оболочка** - Запуск интерфейса

### Обработка ошибок
- Функция `panic()` для критических ошибок
- Трассировка стека при исключениях
- Цветное выделение ошибок в консоли
- Автоматическое восстановление после некритических ошибок

### Оптимизации
- Выравнивание памяти по 32 байта
- Буферизация дисковых операций
- Двойная буферизация для графики
- Ленивая инициализация компонентов

## Расширяемость

Система спроектирована для легкого расширения:
- Модульная архитектура компонентов
- Четкие интерфейсы между подсистемами
- Поддержка новых драйверов устройств
- Возможность добавления новых команд
- Расширяемая файловая система

## Ограничения текущей версии

- Однопоточность (нет планировщика задач)
- Отсутствие сетевой поддержки
- Ограниченная поддержка USB
- Нет поддержки ACPI
- Базовая поддержка звука отсутствует

XCore представляет собой образовательную ОС, демонстрирующую основные принципы разработки операционных систем с современным подходом к архитектуре и безопасности.